var pattern;pattern=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;if(c=["\\","[","]",".","^","$","|","?","*","+","(",")","{","}"],null==b&&(b=!1),e=function(a){var b,d,e;for(d=0,e=c.length;e>d;d++)b=c[d],a=a.replace(b,"\\"+b);return a},h=function(a,b){var c,d,f;return d=/%(\w+)%/g,c=function(){var b;for(b=[];f=d.exec(a);)b.push(f[1]);return b}(),{attributes:c,toExtract:function(b){return f=e(a).replace("%"+b+"%","(?<value>[a-zA-Z0-9_.-]+)"),f=f.replace(d,"[a-zA-Z0-9_.-]+")},toFilter:function(){var c;return c=e(a).replace(d,"[a-zA-Z0-9_.-]+"),b&&(c+="\\b"),{script:{script:"pattern_filter",params:{pattern:c}}}}}},!a)return{query:null,attributes:[],filters:[]};for(m=[],i=[],r=a.split("|"),n=0,p=r.length;p>n;n++)k=r[n],k=k.trim(),0===k.indexOf("parse")?i.push(h(k.substring(5).trim(),b)):m=m.concat(k.split(/\s+/));for(j=0===m.length?null:{bool:{must:function(){var a,b,c;for(c=[],a=0,b=m.length;b>a;a++)l=m[a],c.push({multi_match:{query:l,fields:["_all"]}});return c}()}},d=[],f=[],o=0,q=i.length;q>o;o++)g=i[o],d=d.concat(g.attributes),f.push(g.toFilter());return{query:j,attributes:d,filters:f,toBucket:function(a){var b,c,d;for(c=0,d=i.length;d>c;c++)if(g=i[c],g.attributes.indexOf(a)>=0)return b=g.toExtract(a),{script:"pattern_extract",lang:"groovy",params:{pattern:b,onlyNumber:!1},size:300};return null},toMetric:function(a){var b,c,d;for(c=0,d=i.length;d>c;c++)if(g=i[c],g.attributes.indexOf(a)>=0)return b=g.toExtract(a),{script:"pattern_extract",lang:"groovy",params:{pattern:b,onlyNumber:!0}};return null},applyFilter:function(b,c){var d,e;return d="%"+b+"%",e=a.replace(d,c),a.indexOf(d)+d.length===a.length?pattern(e,!0):pattern(e,!1)}}},angular.module("consoleApp",["tableSort"]).filter("isEmpty",function(){var a;return function(b){for(a in b)if(b.hasOwnProperty(a))return!1;return!0}}).directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}).controller("Ctrl",["$scope","$http","$location",function(a,b){b.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",a.dateRange=$("#daterange").val(),_.extend(a,{_:_,moment:moment,parseInt:parseInt,Math:Math,currentPage:1}),a.page={filter:{field:{}},attributeAggs:"avg",keywords:""},a.fields=[{key:"host",name:"主机名称"},{key:"path",name:"路径"}],a.autoRefresh=!0,a.chartCount={id:"chartCount"},a.chartStat={id:"chartStat"},a.search=function(c){c=c||{},a.currentPage=1,isCustomerRange()&&(a.autoRefresh=!1),a.dateRange.match(/^(\S+) - (\S+)$/)||alert("时间格式错误");var d=RegExp.$1,e=RegExp.$2,f=a.begin=+moment(d,dateFormat),g=a.end=+moment(e,dateFormat);_.extend(a.chartCount,{begin:f,end:g}),a.page.pattern=pattern(a.page.keywords);var h=30,i=a.interval=parseInt((g-f)/h);a.page.filter.timerange={range:{timestamp:{from:moment(f).toISOString(),to:moment(g).toISOString()}}},a.page.query={filtered:{query:a.page.pattern.query,filter:{and:[a.page.filter.timerange]}}},_.each(a.page.filter.field,function(b,c){a.page.query.filtered.filter.and.push({term:_.object([[c,b]])})}),_.each(a.page.pattern.filters,function(b){a.page.query.filtered.filter.and.push(b)}),a.chartCount.highChart&&a.chartCount.highChart.showLoading(),b.post("/console/ajax/search",{esBody:{query:a.page.query,size:100,aggs:{event_over_time:{date_histogram:{field:"timestamp",interval:i+"ms"}}}},begin:f,end:g}).success(function(b){a.page.searchResult=b;var d=b.aggregations?b.aggregations.event_over_time.buckets:[],e=[];if(0==d.length)for(var h=f;g>=h;h+=i)e.push([h,0]);else{var j=(d[0].key-f)%i,k=(g-d[0].key)%i,l=f+j,m=g-k;l<d[0].key&&e.push([l,0]),_.each(d,function(a){e.push([a.key,a.doc_count])}),d.length>1&&m>d[d.length-1].key&&e.push([m,0])}var n=[{name:"数量",type:"column",data:e}];drawChart(a.chartCount,n),setAutoRefresh(),c.reserve||_.map(a.fields,function(a){_.extend(a,{show:!1,buckets:null})})})},a.toggleAutoRefresh=function(){isCustomerRange()||(a.autoRefresh=!a.autoRefresh)},a.toggleField=function(c){c.buckets||(c.loading=!0,b.post("/console/ajax/search",{esBody:{query:a.page.query,size:0,aggs:{unique_number_for_attributes:{terms:{field:c.key,size:300}}}},begin:a.begin,end:a.end}).success(function(a){c.loading=!1,c.buckets=a.aggregations?a.aggregations.unique_number_for_attributes.buckets:[]})),c.show=!c.show},a.filterField=function(b,c){a.page.filter.field[b.key]=c.key,a.search({reserve:!0})},a.removeFieldFilter=function(b){delete a.page.filter.field[b],a.search({reserve:!0})},a.showFieldKeys=function(b){a.modalFieldData={field:b,buckets:b.buckets},$("#modalAllFieldKeys").modal()},a.search(),a.toPage=function(c){a.currentPage!=c&&b.post("/console/ajax/search",{esBody:{query:a.page.query,size:100,from:100*(c-1)},begin:a.begin,end:a.end}).success(function(b){a.page.searchResult=b,a.currentPage=c,$.scrollTo("#resultList",500)})}}]);var drawChart=function(a,b){a.highChart&&a.highChart.destroy();var c={chart:{renderTo:a.id,zoomType:"x",events:{selection:function(a){var b="%Y-%m-%dT%H:%M:%S.%L",c=Highcharts.dateFormat(b,a.xAxis[0].min),d=Highcharts.dateFormat(b,a.xAxis[0].max);window.chosenLabel="自定义范围",$("#daterange").val(c+" - "+d),$("#daterange").trigger("change")}}},credits:{enabled:!1},rangeSelector:{enabled:!1},navigator:{enabled:!1},scrollbar:{enabled:!1},legend:{enabled:b.length>1},series:b,tooltip:{valueDecimals:0,dateTimeLabelFormats:{millisecond:"%Y-%m-%dT%H:%M:%S.%L",second:"%Y-%m-%dT%H:%M:%S.%L",minute:"%Y-%m-%dT%H:%M",hour:"%Y-%m-%dT%H:%M",day:"%Y-%m-%dT%H:%M",week:"Week from %A, %b %e, %Y",month:"%B %Y",year:"%Y"}},xAxis:{ordinal:!1,minRange:1e3,dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m.%e",week:"%e. %b",month:"%b '%y",year:"%Y"}},yAxis:{floor:0,gridLineColor:"#EEE"},plotOptions:{series:{marker:{enabled:!0}}}};a.highChart=new Highcharts.StockChart(c)};$("[data-rel=tooltip]").tooltip({container:"body"}),Highcharts.setOptions({global:{timezoneOffset:(new Date).getTimezoneOffset()},lang:{weekdays:["周日","周一","周二","周三","周四","周五","周六"]}});var chosenLabel="过去1小时",dateFormat="YYYY-MM-DDTHH:mm:ss.SSS",isCustomerRange=function(a){return a=a||chosenLabel,-1===a.indexOf("过去")},getDatePickerOpts=function(){var a={"过去1小时":[moment().subtract(1,"hour"),moment()],"过去6小时":[moment().subtract(6,"hour"),moment()],"昨天":[moment().subtract(1,"day").startOf("day"),moment().subtract(1,"day").endOf("day")],"过去1天":[moment().subtract(1,"day"),moment()],"过去1周":[moment().subtract(1,"week"),moment()],"过去15天":[moment().subtract(1,"month"),moment()],"过去2月":[moment().subtract(2,"month"),moment()]},b={opens:"left",timePicker:!0,timePicker12Hour:!1,timePickerIncrement:15,ranges:a,format:dateFormat,minDate:moment().subtract(15,"day"),minDate:moment().subtract(60,"day"),maxDate:moment(),locale:{applyLabel:"应用",cancelLabel:"取消",fromLabel:"从",toLabel:"到",weekLabel:"W",customRangeLabel:"自定义范围",daysOfWeek:moment.weekdaysMin(),monthNames:moment.monthsShort(),firstDay:moment.localeData()._week.dow}};if(isCustomerRange()){var c=$("#daterange").data("daterangepicker");return _.extend(b,{startDate:c.startDate,endDate:c.endDate})}return _.extend(b,{startDate:a[chosenLabel][0],endDate:a[chosenLabel][1]})},datePickerOpts=getDatePickerOpts();$("#daterange").daterangepicker(datePickerOpts),$("#daterange").on("apply.daterangepicker",function(a,b){if(isCustomerRange()&&!isCustomerRange(b.chosenLabel)){var c=angular.element($("body")).scope();c.autoRefresh=!0}chosenLabel=b.chosenLabel,$("#daterange").trigger("change")});var setDateRange=function(){$("#daterange").val(moment(datePickerOpts.startDate).format(dateFormat)+" - "+moment(datePickerOpts.endDate).format(dateFormat)),$("#daterange").trigger("apply.daterangepicker",$("#daterange").data("daterangepicker"))};setDateRange();var setAutoRefresh=function(){window.refreshTimer&&clearInterval(window.refreshTimer),window.refreshTimer=setInterval(function(){var a=angular.element($("body")).scope();a.autoRefresh&&(datePickerOpts=getDatePickerOpts(),$("#daterange").data("daterangepicker").setOptions(datePickerOpts),setDateRange())},6e4)};
//# sourceMappingURL=search.min.js.map