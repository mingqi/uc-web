require(["/b/js/config.js"],function(){require(["jquery","underscore","angular","bootstrap","angular-tablesort"],function(e,t,n){angular.module("consoleApp",["tableSort"]).filter("isEmpty",function(){var e;return function(t){for(e in t)if(t.hasOwnProperty(e))return!1;return!0}}).directive("ngEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){t.which===13&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}).controller("Ctrl",["$scope","$http","$location",function(n,i,u){i.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",n.dateRange=e("#daterange").val(),t.extend(n,{_:t,moment:moment,parseInt:parseInt,Math:Math,currentPage:1}),n.page={filter:{field:{}},attributeAggs:"avg",keywords:""},n.fields=[{key:"host",name:"主机名称"},{key:"path",name:"路径"}],n.autoRefresh=!0,n.chartCount={id:"chartCount"},n.chartStat={id:"chartStat"},n.search=function(e){e=e||{},n.currentPage=1,o()&&(n.autoRefresh=!1),n.dateRange.match(/^(\S+) - (\S+)$/)||alert("时间格式错误");var u=RegExp.$1,a=RegExp.$2,f=n.begin=+moment(u,s),c=n.end=+moment(a,s);t.extend(n.chartCount,{begin:f,end:c}),n.page.pattern=pattern(n.page.keywords);var h=30,p=n.interval=parseInt((c-f)/h);n.page.filter.timerange={range:{timestamp:{from:moment(f).toISOString(),to:moment(c).toISOString()}}},n.page.query={filtered:{query:n.page.pattern.query,filter:{and:[n.page.filter.timerange]}}},t.each(n.page.filter.field,function(e,r){n.page.query.filtered.filter.and.push({term:t.object([[r,e]])})}),t.each(n.page.pattern.filters,function(e){n.page.query.filtered.filter.and.push(e)}),n.chartCount.highChart&&n.chartCount.highChart.showLoading(),i.post("/console/ajax/search",{esBody:{query:n.page.query,size:100,aggs:{event_over_time:{date_histogram:{field:"timestamp",interval:p+"ms"}}}},begin:f,end:c}).success(function(i){n.page.searchResult=i;var s=i.aggregations?i.aggregations.event_over_time.buckets:[],o=[];if(s.length==0)for(var u=f;u<=c;u+=p)o.push([u,0]);else{var a=(s[0].key-f)%p,h=(c-s[0].key)%p,d=f+a,v=c-h;d<s[0].key&&o.push([d,0]),t.each(s,function(e){o.push([e.key,e.doc_count])}),s.length>1&&v>s[s.length-1].key&&o.push([v,0])}var m=[{name:"数量",type:"column",data:o}];r(n.chartCount,m),l(),e.reserve||t.map(n.fields,function(e){t.extend(e,{show:!1,buckets:null})})})},n.toggleAutoRefresh=function(){o()||(n.autoRefresh=!n.autoRefresh)},n.toggleField=function(e){e.buckets||(e.loading=!0,i.post("/console/ajax/search",{esBody:{query:n.page.query,size:0,aggs:{unique_number_for_attributes:{terms:{field:e.key,size:300}}}},begin:n.begin,end:n.end}).success(function(t){e.loading=!1,e.buckets=t.aggregations?t.aggregations.unique_number_for_attributes.buckets:[]})),e.show=!e.show},n.filterField=function(e,t){n.page.filter.field[e.key]=t.key,n.search({reserve:!0})},n.removeFieldFilter=function(e){delete n.page.filter.field[e],n.search({reserve:!0})},n.showFieldKeys=function(t){n.modalFieldData={field:t,buckets:t.buckets},e("#modalAllFieldKeys").modal()},n.search(),n.toPage=function(t){if(n.currentPage==t)return;i.post("/console/ajax/search",{esBody:{query:n.page.query,size:100,from:(t-1)*100},begin:n.begin,end:n.end}).success(function(r){n.page.searchResult=r,n.currentPage=t,e.scrollTo("#resultList",500)})}}]);var r=function(t,n){t.highChart&&t.highChart.destroy();var r={chart:{renderTo:t.id,zoomType:"x",events:{selection:function(t){var n="%Y-%m-%dT%H:%M:%S.%L",r=Highcharts.dateFormat(n,t.xAxis[0].min),i=Highcharts.dateFormat(n,t.xAxis[0].max);window.chosenLabel="自定义范围",e("#daterange").val(r+" - "+i),e("#daterange").trigger("change")}}},credits:{enabled:!1},rangeSelector:{enabled:!1},navigator:{enabled:!1},scrollbar:{enabled:!1},legend:{enabled:n.length>1},series:n,tooltip:{valueDecimals:0,dateTimeLabelFormats:{millisecond:"%Y-%m-%dT%H:%M:%S.%L",second:"%Y-%m-%dT%H:%M:%S.%L",minute:"%Y-%m-%dT%H:%M",hour:"%Y-%m-%dT%H:%M",day:"%Y-%m-%dT%H:%M",week:"Week from %A, %b %e, %Y",month:"%B %Y",year:"%Y"}},xAxis:{ordinal:!1,minRange:1e3,dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m.%e",week:"%e. %b",month:"%b '%y",year:"%Y"}},yAxis:{floor:0,gridLineColor:"#EEE"},plotOptions:{series:{marker:{enabled:!0}}}};t.highChart=new Highcharts.StockChart(r)};e("[data-rel=tooltip]").tooltip({container:"body"}),Highcharts.setOptions({global:{timezoneOffset:(new Date).getTimezoneOffset()},lang:{weekdays:["周日","周一","周二","周三","周四","周五","周六"]}});var i="过去1小时",s="YYYY-MM-DDTHH:mm:ss.SSS",o=function(e){return e=e||i,e.indexOf("过去")===-1},u=function(){var n={"过去1小时":[moment().subtract(1,"hour"),moment()],"过去6小时":[moment().subtract(6,"hour"),moment()],"昨天":[moment().subtract(1,"day").startOf("day"),moment().subtract(1,"day").endOf("day")],"过去1天":[moment().subtract(1,"day"),moment()],"过去1周":[moment().subtract(1,"week"),moment()],"过去15天":[moment().subtract(1,"month"),moment()],"过去2月":[moment().subtract(2,"month"),moment()]},r={opens:"left",timePicker:!0,timePicker12Hour:!1,timePickerIncrement:15,ranges:n,format:s,minDate:moment().subtract(15,"day"),minDate:moment().subtract(60,"day"),maxDate:moment(),locale:{applyLabel:"应用",cancelLabel:"取消",fromLabel:"从",toLabel:"到",weekLabel:"W",customRangeLabel:"自定义范围",daysOfWeek:moment.weekdaysMin(),monthNames:moment.monthsShort(),firstDay:moment.localeData()._week.dow}};if(o()){var u=e("#daterange").data("daterangepicker");return t.extend(r,{startDate:u.startDate,endDate:u.endDate})}return t.extend(r,{startDate:n[i][0],endDate:n[i][1]})},a=u();e("#daterange").daterangepicker(a),e("#daterange").on("apply.daterangepicker",function(t,n){if(o()&&!o(n.chosenLabel)){var r=angular.element(e("body")).scope();r.autoRefresh=!0}i=n.chosenLabel,e("#daterange").trigger("change")});var f=function(){e("#daterange").val(moment(a.startDate).format(s)+" - "+moment(a.endDate).format(s)),e("#daterange").trigger("apply.daterangepicker",e("#daterange").data("daterangepicker"))};f();var l=function(){window.refreshTimer&&clearInterval(window.refreshTimer),window.refreshTimer=setInterval(function(){var t=angular.element(e("body")).scope();if(!t.autoRefresh)return;a=u(),e("#daterange").data("daterangepicker").setOptions(a),f()},6e4)}})});