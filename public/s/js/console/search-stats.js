(function(){var e,t;t=function(e,t){var n,r,i,s,o,u,a,f,l,c;c=[t.startDate,t.endDate],f=c[0],o=c[1],r=(e!=null?e.event_over_time.buckets:void 0)||[],i=[];if(r.length===0){s=+f;while(s<=+o)i.push([s,0]),s+=t.interval}else n=(r[0].key-f)%t.interval,a=(o-r[0].key)%t.interval,u=f+n,l=o-a,u<r[0].key&&i.push([u,0]),_.each(r,function(e){var t;i.push([e.key,((t=e.metric_value)!=null?t.value:void 0)||e.doc_count])}),r.length>1&&l>r[r.length-1].key&&i.push([l,0]);return i},e={id:"chartStats"},define(["underscore"],function(n){return function(r,i,s){return r.stats={init:function(){return this.chartTypes=[{icon:"fa-line-chart",value:"line",text:"折线图"},{icon:"fa-bar-chart",value:"bar",text:"柱状图"},{icon:"fa-pie-chart",value:"pie",text:"饼图"}],this.aggs=[],this.groups=[],this.selectedChartType=this.chartTypes[0],this.selectedAgg=this.aggs[0],this.type="event_count"},serialize:function(){var e,t,n,r;return JSON.stringify({chartType:(e=this.selectedChartType)!=null?e.value:void 0,field:(t=this.selectedField)!=null?t.key:void 0,agg:(n=this.selectedAgg)!=null?n.value:void 0,group:(r=this.selectedGroup)!=null?r.key:void 0})},deserialize:function(){var e,t,n,r,i,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;u=s.search().stats;try{o=JSON.parse(u),m=this.chartTypes;for(a=0,h=m.length;a<h;a++){t=m[a];if(t.value===o.chartType){this.selectedChartType=t;break}}g=this.fields;for(f=0,p=g.length;f<p;f++){r=g[f];if(r.key===o.field){this.selectedField=r;break}}y=this.aggs;for(l=0,d=y.length;l<d;l++){e=y[l];if(e.value===o.agg){this.selectedAgg=e;break}}b=this.groups,w=[];for(c=0,v=b.length;c<v;c++){i=b[c];if(i.key===o.group){this.selectedGroup=i;break}w.push(void 0)}return w}catch(E){n=E}},setFileds:function(){return this.fields=r.fields,this.selectedField||(this.selectedField=this.fields[0]),this.setGroups()},setAggs:function(){var e;this.selectedField&&(this.selectedField.isNumeric?e=[{value:"avg",title:"平均"},{value:"sum",title:"求和"},{value:"max",title:"最大值"},{value:"min",title:"最小值"}]:e=[{value:"cardinality",title:"不重复数量"}]);if(e.length!==this.aggs.length)return this.aggs=e,this.selectedAgg=this.aggs[0]},setGroups:function(){var e,t,n,r,i,s,o;this.groups=[],r=this.fields;for(t=0,n=r.length;t<n;t++){e=r[t];if(e.isNumeric)continue;if(this.type!=="event_count"&&e.key===((i=this.selectedField)!=null?i.key:void 0))continue;this.groups.push(e)}if(this.type!=="event_count"&&((s=this.selectedGroup)!=null?s.key:void 0)===((o=this.selectedField)!=null?o.key:void 0))return this.selectedGroup=""},chartTypeChange:function(e){return this.selectedChartType=e,this.optionsChange()},optionsChange:function(){return this.setGroups(),this.setAggs(),this.showStats()},showStats:function(){var o,u,a,f;if(r.page.tab!=="stats")return;if(!r.page.searchResult||r.page.searchResult.hits.total===0)return;return s.search("stats",this.serialize()),e.highChart!=null&&e.highChart.showLoading(),u=null,this.type==="event_count"?u={}:(o=this.selectedAgg.value,u={metric_value:{}},u.metric_value[this.selectedAgg.value]={field:this.selectedField.key}),this.selectedChartType.value==="line"&&(u={event_over_time:{date_histogram:{field:"timestamp",interval:r.interval+"ms"},aggs:u}}),this.selectedGroup&&(u={group_info:{terms:{field:this.selectedGroup.key,size:10},aggs:u}}),a={query:r.page.query,size:0,aggs:u},f="",this.type==="event_count"?f="日志数量":(this.selectedField&&(f+=this.selectedField.name),this.selectedAgg&&(f+=" - "+this.selectedAgg.title)),i.post("/console/ajax/search",{esBody:a,begin:+r.startDate,end:+r.endDate}).success(function(i){return function(s){var o,u,a,l,c,h;l=0,i.selectedChartType.value==="line"?i.selectedGroup?l=350:l=300:i.selectedChartType.value==="bar"?i.selectedGroup?(u=s.aggregations.group_info.buckets,l=60+u.length*35):l=100:i.selectedChartType.value==="pie"&&(l=300),$("#chartStats").height(l);if(i.selectedChartType.value==="line")return i.selectedGroup?(h=n.chain(s.aggregations.group_info.buckets).map(function(e){var n;return n=t(e,r),{name:e.key,type:"line",data:n}}).value(),r.drawChart(e,h,{title:{text:f}})):(c=t(s.aggregations,r),h=[{name:f,type:"line",data:c}],r.drawChart(e,h,{title:{text:f}}));if(i.selectedChartType.value==="bar")return i.type==="event_count"?i.selectedGroup?(u=s.aggregations.group_info.buckets,c=function(){var e,t,n;n=[];for(e=0,t=u.length;e<t;e++)o=u[e],n.push(o.doc_count);return n}(),a=function(){var e,t,n;n=[];for(e=0,t=u.length;e<t;e++)o=u[e],n.push(o.key);return n}()):(c=[s.hits.total],a=["全部"]):i.selectedGroup?(u=s.aggregations.group_info.buckets,c=function(){var e,t,n;n=[];for(e=0,t=u.length;e<t;e++)o=u[e],n.push(o.metric_value.value);return n}(),a=function(){var e,t,n;n=[];for(e=0,t=u.length;e<t;e++)o=u[e],n.push(o.key);return n}()):(c=[s.aggregations.metric_value.value],a=["全部"]),r.drawChart(e,[{data:c,type:"bar"}],{basicChart:1,chart:{renderTo:e.id},plotOptions:{bar:{dataLabels:{enabled:!0,formatter:function(){return Highcharts.numberFormat(this.y,0)}}}},title:{text:f},tooltip:{valueDecimals:0,pointFormat:"<b>{point.y}</b>"},xAxis:{categories:a,title:{text:null}},yAxis:{floor:0,title:{text:null},min:0,labels:{overflow:"justify"}}});if(i.selectedChartType.value==="pie")return i.type==="event_count"?i.selectedGroup?(u=s.aggregations.group_info.buckets,c=function(){var e,t,n;n=[];for(e=0,t=u.length;e<t;e++)o=u[e],n.push([o.key,o.doc_count]);return n}()):c=[["全部",s.hits.total]]:i.selectedGroup?(u=s.aggregations.group_info.buckets,c=function(){var e,t,n;n=[];for(e=0,t=u.length;e<t;e++)o=u[e],n.push([o.key,o.metric_value.value]);return n}()):c=[["全部",s.aggregations.metric_value.value]],console.log("aaaaaaaaa: "+JSON.stringify(c)),c=c.map(function(e){var t,r;return t=e[0],r=e[1],n.isNumber(t)&&(t=t.toString()),[t,r]}),r.drawChart(e,[{data:c}],{basicChart:1,chart:{renderTo:e.id,type:"pie"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %"}}},title:{text:f},tooltip:{pointFormat:"<b>{point.percentage:.1f} %</b>"}})}}(this))}}}})}).call(this);